<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>cs-cache - stardustman</title>
<meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=Cache-Control content="no-transform"><meta http-equiv=Cache-Control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="stardust"><meta name=description content="There can be many caches stacked on top of each other. Cache 可以一层一层累积。 if you miss in one you try in the “lower level cache” Lower level, mean higher number. 在上层的 Cache miss 了，可以在下层的 Cache 去找。依次类推"><meta name=keywords content="Hugo,theme,even"><meta name=generator content="Hugo 0.120.4 with theme even"><link rel=canonical href=http://stardustman.github.io/2020/12/01/cs-cache/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><meta property="og:title" content="cs-cache"><meta property="og:description" content="There can be many caches stacked on top of each other. Cache 可以一层一层累积。 if you miss in one you try in the “lower level cache” Lower level, mean higher number. 在上层的 Cache miss 了，可以在下层的 Cache 去找。依次类推"><meta property="og:type" content="article"><meta property="og:url" content="http://stardustman.github.io/2020/12/01/cs-cache/"><meta property="article:section" content="post"><meta property="article:published_time" content="2020-12-01T08:40:29+08:00"><meta property="article:modified_time" content="2020-12-01T08:40:29+08:00"><meta itemprop=name content="cs-cache"><meta itemprop=description content="There can be many caches stacked on top of each other. Cache 可以一层一层累积。 if you miss in one you try in the “lower level cache” Lower level, mean higher number. 在上层的 Cache miss 了，可以在下层的 Cache 去找。依次类推"><meta itemprop=datePublished content="2020-12-01T08:40:29+08:00"><meta itemprop=dateModified content="2020-12-01T08:40:29+08:00"><meta itemprop=wordCount content="752"><meta itemprop=keywords content="notion,cache,"><meta name=twitter:card content="summary"><meta name=twitter:title content="cs-cache"><meta name=twitter:description content="There can be many caches stacked on top of each other. Cache 可以一层一层累积。 if you miss in one you try in the “lower level cache” Lower level, mean higher number. 在上层的 Cache miss 了，可以在下层的 Cache 去找。依次类推"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>keep writing</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/2022/03/27/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>keep writing</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/2022/03/27/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>cs-cache</h1><div class=post-meta><span class=post-time>2020-12-01 </span><span class=more-meta>752 words </span><span class=more-meta>2 mins read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#cache-指导思想>cache 指导思想</a><ul><li><a href=#局部性原理>局部性原理</a></li></ul></li><li><a href=#基本问题>基本问题</a><ul><li><a href=#怎样找到-cache-中的数据>怎样找到 cache 中的数据？</a></li><li><a href=#实例分析>实例分析</a></li><li><a href=#cache-哪一种-address>cache 哪一种 address？</a></li></ul></li><li><a href=#references>References</a></li></ul></li></ul></nav></div></div><div class=post-content><blockquote><p>There can be many caches <code>stacked</code> on top of each other.
Cache 可以一层一层累积。</p></blockquote><ol><li>if you miss in one you try in the “lower level cache”
Lower level, mean higher number.
在上层的 Cache miss 了，可以在下层的 Cache 去找。依次类推。</li><li>There can also be <code>separate</code> caches for data and
instructions. Or the cache can be <code>“unified”</code>.
数据和指令的 Cache 可以独立，也可以混合。</li><li>to wit:<ul><li>the <code>L1 data cache (d-cache)</code> is the one nearest processor. It
corresponds to the “data memory” block in our pipeline
diagrams</li><li>the <code>L1 instruction cache (i-cache)</code> corresponds to the
“instruction memory” block in our pipeline diagrams.</li><li>The L2 sits <code>underneath</code> the L1s.</li><li>There is often an <code>L3 in modern systems</code>.</li></ul></li></ol><h2 id=cache-指导思想>cache 指导思想</h2><h3 id=局部性原理>局部性原理</h3><h4 id=temporal-locality-时间局部性>temporal locality (时间局部性)</h4><p>Taking advantage of temporal locality:</p><ol><li>bring data into cache whenever its referenced</li><li>kick out something that hasn’t been used recently</li></ol><h4 id=spatial-locality-空间局部性>spatial locality (空间局部性)</h4><p>Taking advantage of spatial locality:
bring in a block of <code>contiguous data (cacheline)</code>, not just
the <code>requested data</code>.</p><h2 id=基本问题>基本问题</h2><h3 id=怎样找到-cache-中的数据>怎样找到 cache 中的数据？</h3><blockquote><p>以 32bits 的内存地址，来分析。
(index, offset) 二维坐标来定位一个 byte 的数据。</p></blockquote><h4 id=index>index</h4><p>定位 cache line，可视为<code>横坐标</code>。
现在可以通过 cache lines = cache size / cache line size 来计算。
index bits = log2(cache lines)</p><h4 id=offset>offset</h4><p>通过 index 定位到 cache line 后，offset 定位到这个 cache line 的哪一个 byte。
可以视为<code>纵坐标</code>。
offset bits = log2(offset)</p><h4 id=tag>tag</h4><p>32bits 剩下的部分。</p><h4 id=cache-line-应该是多大>cache line 应该是多大？</h4><blockquote><p>这其实是分块(block)思想。在利用空间局部性原理。</p></blockquote><h5 id=cache-line-size-越大>cache line size 越大</h5><ol><li>Exploits more spatial locality.</li><li>Large cache lines effectively prefetch data that we have not
explicitly asked for.
更好地利用空间局部性，提前获取将要访问的数据。</li></ol><h5 id=cache-line-size-越小>cache line size 越小</h5><ol><li>Focuses on temporal locality.</li><li>If there is little spatial locality, large cache lines waste
space and bandwidth.
聚焦在时间局部性上，如果没有较好的空间局部性，提前 <code>fetch</code> 了数据，那就浪费了空间和带宽。</li></ol><p><img src=https://github.com/stardustman/pictures/raw/main/img/cache_organization.svg alt=cache_organization> #(cache 组织方式)</p><h3 id=实例分析>实例分析</h3><p>内存地址 32bits。</p><h4 id=1024-cache-lines-32-bytes-per-line>1024 cache lines, 32 Bytes per line.</h4><p>index bits = log2(1024) = 10
offset bits = log2(32) = 5
tags bits = 32 - index - offset = 17</p><h4 id=32kb-cache-64byte-lines>32KB cache, 64byte lines</h4><p>index bits = log2(32KB / 64Bytes) = 9
offset bits = log2(64) = 6
tags bits = 32 - 9 - 6 = 17</p><h4 id=set-是干什么的>set 是干什么的？</h4><p>(set) <code>Associativity</code> means providing <code>more than one</code> place for a cache line to live.
One group of lines corresponds to each index.</p><ol><li>it is called a “set”</li><li><code>Each line</code> in a set is called a <code>“way”</code></li><li>N-Way associativity requires N parallel comparators
set = ？</li></ol><p>{% asset_img cache-2-ways-cache.svg 2-ways-cache%}
<img src=https://github.com/stardustman/pictures/raw/main/img/cache-2-ways-cache.svg alt=2-ways-cache></p><h3 id=cache-哪一种-address>cache 哪一种 address？</h3><h4 id=virtual-memory-address>virtual memory address</h4><h4 id=physical-memory-address>physical memory address</h4><p><img src=https://github.com/stardustman/pictures/raw/main/img/cache-memory-address-type.svg alt=cache-memory-address-type> #(缓存类型)</p><h2 id=references>References</h2><ol><li><a href=http://cseweb.ucsd.edu/classes/wi12/cse141-a/Slides/09_Cache_intro.pdf>CSE141-Caching-Intro</a></li><li><a href=http://cseweb.ucsd.edu/classes/sp10/cse141/pdf/07/09_CSE141-Caching.pdf>CSE141-Caching</a></li><li><a href=http://cseweb.ucsd.edu/classes/wi12/cse141-a/Slides/10_Caches_detail.pdf>CSE141-Caches-Details</a></li><li><a href=https://www.0xffffff.org/2014/01/06/26-x86-cache/>x86-cache</a></li><li><a href=https://www.kernel.org/doc/html/latest/admin-guide/mm/memory-hotplug.html>memory-hotplug</a></li><li><a href=https://zhuanlan.zhihu.com/p/31859105>Cache 是怎样组织和工作的？</a></li><li><a href=https://docs.microsoft.com/en-us/sysinternals/downloads/coreinfo>cacheinfo-windows</a></li><li><a href=https://manybutfinite.com/post/intel-cpu-caches/>intel-cpu-cache</a></li><li><a href=http://www.cs.cornell.edu/courses/cs3410/2013sp/lecture/18-caches3-w.pdf>caches3-w.pdf</a></li><li><a href=https://en.wikipedia.org/wiki/CPU_cache>wiki-cpu-cache</a></li><li><a href=https://www.cs.princeton.edu/courses/archive/fall19/cos316/lectures/10-cpu-cache.pdf>cos316-10-cpu-cache.pdf</a></li><li><a href=http://aturing.umcs.maine.edu/~meadow/courses/cos335/Intel-CacheOverview.pdf>cos355-Intel-CacheOverview</a></li><li><a href=https://zhuanlan.zhihu.com/p/31875174>细说Cache-L1/L2/L3/TLB</a></li></ol></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>stardust</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2020-12-01</span></p><p class=copyright-item><span class=item-title>Markdown</span>
<span class=item-content><a class=link-to-markdown href=http://stardustman.github.io/2020/12/01/cs-cache/index.md target=_blank>The Markdown version »</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/notion/>notion</a>
<a href=/tags/cache/>cache</a></div><nav class=post-nav><a class=prev href=/2020/12/14/cs-lock/><i class="iconfont icon-left"></i>
<span class="prev-text nav-default">cs-lock</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/2020/11/30/acknowledgement-timeout-retry-sequence-number/><span class="next-text nav-default">acknowledgement-timeout-retry-sequence-number</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><script src=https://utteranc.es/client.js repo=stardustman/comments issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:aoyunyoung@gmail.com class="iconfont icon-email" title=email></a><a href=https://stackoverflow.com/users/9112817/cloud-young class="iconfont icon-stack-overflow" title=stack-overflow></a><a href=https://github.com/stardustman class="iconfont icon-github" title=github></a><a href=http://stardustman.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a>
</span><span class=copyright-year>&copy;
2019 -
2023<span class=heart><i class="iconfont icon-heart"></i></span><span>stardust</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js></script></body></html>